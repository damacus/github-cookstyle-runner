# Dockerfile.test
FROM ruby:3.2-slim

LABEL maintainer="Damacus <me@damacus.io>"
LABEL description="Test environment for github-cookstyle-runner"

# Install base dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    build-essential \
    ca-certificates \
    bash \
 && rm -rf /var/lib/apt/lists/*

# Set up working directory
WORKDIR /usr/src/app

# Copy Gemfile and install dependencies
COPY Gemfile* ./
RUN bundle install --jobs $(nproc) --retry 3

# Copy the application code
COPY . .

# Create a directory for test fixtures
RUN mkdir -p /usr/src/app/spec/fixtures

# Ensure no local configuration is used
ENV GITHUB_TOKEN=""
ENV GITHUB_APP_ID=""
ENV GITHUB_APP_INSTALLATION_ID=""
ENV GITHUB_APP_PRIVATE_KEY=""

# Default command to run tests
CMD ["bundle", "exec", "rspec"]
